'use strict';
const http = require('http');
var request = require('request');
let sector = "BS";
let price = "120000";

//replace this with the url to the azure function
const apiUrl = "https://fnsalesduration.azurewebsites.net/api/HttpTriggerCSharp1?code=pvAKe489uyZs9ORPbKJGIeUyI/47Jp/YMwbzkzbYfaMDGwiXjbebPg==";
exports.salesduration = (req, res) => {
  // Get the price and sector from the request
  price = req.body.queryResult.parameters['price']; 
  sector = req.body.queryResult.parameters['sector']; 

  callSalesDurationApi(price, sector).then((output) => {
    res.json({ 'fulfillmentText': output }); // Return the results 
  })
    .catch((err) => {
      console.log(err);
      res.json({ 'fulfillmentText': err.message });
    })
    ;
};

function callSalesDurationApi(price, sector) {
  return new Promise((resolve, reject) => {

    console.log('API Request: ' + apiUrl);

    var myJSONObject = { "sector" : sector,
                          "price": price
    };

    request({
      url: apiUrl,
      method: "POST",
      json: true,  
      body: myJSONObject
    }, function (error, response, body) {
      
      let output = "The prediction is " + sector +
      " for a listing price of " + price + " is: " + body;

      console.log(output);
      console.log(body);
      resolve(output);

    });

  });
}
